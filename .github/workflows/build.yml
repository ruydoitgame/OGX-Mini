name: Build OGX-Mini Firmware (PS3 Fixed)

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        # Danh sách các board bạn muốn build
        board: [PI_PICO, PI_PICO2, RP2040_ZERO, ADAFRUIT_FEATHER]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Install ARM toolchain and dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake ninja-build gcc-arm-none-eabi \
          libnewlib-arm-none-eabi libstdc++-arm-none-eabi-newlib
    
    - name: Build for ${{ matrix.board }}
      run: |
        cd Firmware/RP2040
        # Xóa build cũ nếu có và tạo mới
        rm -rf build_${{ matrix.board }}
        mkdir -p build_${{ matrix.board }}
        cd build_${{ matrix.board }}
        cmake -S .. -B . -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          -DOGXM_BOARD=${{ matrix.board }} \
          -DMAX_GAMEPADS=1
        cmake --build .
    
    - name: Upload firmware for ${{ matrix.board }}
      uses: actions/upload-artifact@v4
      with:
        # Đặt tên artifact riêng biệt cho từng board để tránh lỗi v4
        name: OGX-Mini-${{ matrix.board }}
        path: Firmware/RP2040/build_${{ matrix.board }}/OGX-Mini.uf2
