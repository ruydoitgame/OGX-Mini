name: Build OGX-Mini Firmware (PS3 Fixed)

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Install ARM toolchain and dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake ninja-build gcc-arm-none-eabi \
          libnewlib-arm-none-eabi libstdc++-arm-none-eabi-newlib

    - name: Set up Pico SDK
      run: |
        git clone --depth 1 --branch 1.5.1 https://github.com/raspberrypi/pico-sdk.git $HOME/pico-sdk
        cd $HOME/pico-sdk
        git submodule update --init
        # Thiết lập biến môi trường cho toàn bộ các bước sau
        echo "PICO_SDK_PATH=$HOME/pico-sdk" >> $GITHUB_ENV
        echo "PICO_BOARD=pico" >> $GITHUB_ENV

    - name: Build for Pi Pico
      env:
        # Ép biến môi trường một lần nữa tại bước build
        PICO_BOARD: pico
        PICO_SDK_PATH: ${{ github.workspace }}/../../pico-sdk
      run: |
        cd Firmware/RP2040
        mkdir -p build
        cd build
        # Sử dụng đường dẫn tuyệt đối cho SDK và chỉ định board trực tiếp
        cmake -S .. -B . -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          -DPICO_SDK_PATH=$HOME/pico-sdk \
          -DPICO_BOARD=pico \
          -DOGXM_BOARD=PI_PICO \
          -DMAX_GAMEPADS=1
        cmake --build .
    
    - name: Upload Pi Pico firmware
      uses: actions/upload-artifact@v4
      with:
        name: OGX-Mini-PiPico
        path: Firmware/RP2040/build/OGX-Mini.uf2
